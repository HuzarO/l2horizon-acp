{% extends 'layouts/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Fishing Game" %}{% endblock %}

{% block extrastyle %}
<style>
    .fishing-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .fishing-main {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
    }

    .fishing-main::before {
        content: 'üåä';
        position: absolute;
        font-size: 10rem;
        opacity: 0.1;
        right: -50px;
        bottom: -50px;
    }

    .rod-info {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        color: white;
    }

    .xp-bar-container {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        height: 30px;
        margin-top: 10px;
        overflow: hidden;
    }

    .xp-bar {
        background: linear-gradient(90deg, #4ade80, #22c55e);
        height: 100%;
        transition: width 0.5s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }

    .fishing-pond {
        background: linear-gradient(180deg, #3b82f6 0%, #1e40af 100%);
        border: 5px solid #1e3a8a;
        border-radius: 20px;
        height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 30px 0;
        position: relative;
        overflow: hidden;
    }

    .fishing-pond::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 50%;
        background: linear-gradient(180deg, transparent, rgba(0, 0, 0, 0.3));
    }

    .fish-caught {
        font-size: 6rem;
        animation: fish-jump 1s ease-out;
    }

    @keyframes fish-jump {
        0% { transform: translateY(200px) scale(0); opacity: 0; }
        50% { transform: translateY(-50px) scale(1.2); opacity: 1; }
        100% { transform: translateY(0) scale(1); opacity: 1; }
    }

    .cast-button {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: none;
        color: white;
        padding: 20px 60px;
        font-size: 1.5rem;
        font-weight: bold;
        border-radius: 50px;
        cursor: pointer;
        box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        transition: all 0.3s;
        display: block;
        margin: 0 auto;
    }

    .cast-button:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.6);
    }

    .cast-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .cast-button.casting {
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .fish-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }

    .fish-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
    }

    .fish-card:hover {
        transform: translateY(-5px);
    }

    .fish-icon {
        font-size: 3rem;
    }

    .rarity-common { border-left: 5px solid #9ca3af; }
    .rarity-rare { border-left: 5px solid #3b82f6; }
    .rarity-epic { border-left: 5px solid #a855f7; }
    .rarity-legendary { border-left: 5px solid #fbbf24; }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }

    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
    }

    .bait-shop {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-top: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .bait-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #eee;
    }

    .bait-item:last-child {
        border-bottom: none;
    }

    .buy-bait-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .buy-bait-btn:hover {
        background: #5568d3;
        transform: scale(1.05);
    }

    .active-bait {
        background: #dcfce7;
        border: 2px solid #22c55e;
    }

    .result-message {
        text-align: center;
        color: white;
        font-size: 1.5rem;
        margin: 20px 0;
        min-height: 50px;
    }
</style>
{% endblock %}

{% block content %}
<div class="fishing-container">
    <h1 class="text-center mb-4">üé£ {% trans "Fishing Game" %}</h1>

    <div class="row">
        <div class="col-lg-8">
            <div class="fishing-main">
                <!-- Rod Info -->
                <div class="rod-info">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4>üé£ {% trans "Sua Vara" %} - Level {{ rod.level }}</h4>
                            <p class="mb-0">üí∞ {% trans "Fichas" %}: <strong id="user-fichas">{{ user_fichas }}</strong></p>
                        </div>
                        <div class="text-end">
                            <div>‚≠ê XP: {{ rod.experience }} / {{ xp_for_next_level }}</div>
                        </div>
                    </div>
                    <div class="xp-bar-container">
                        <div class="xp-bar" style="width: {{ xp_percentage }}%">
                            {{ xp_percentage }}%
                        </div>
                    </div>
                </div>

                <!-- Fishing Pond -->
                <div class="fishing-pond" id="fishing-pond">
                    <div id="pond-content" style="z-index: 10;">
                        <div style="font-size: 4rem; text-align: center; color: white;">
                            üé£<br>
                            <small style="font-size: 1.5rem;">{% trans "Clique para pescar!" %}</small>
                        </div>
                    </div>
                </div>

                <!-- Result Message -->
                <div class="result-message" id="result-message"></div>

                <!-- Cast Button -->
                <button class="cast-button" id="cast-button" onclick="castLine()">
                    üé£ {% trans "LAN√áAR LINHA" %} (1 {% trans "Ficha" %})
                </button>

                <!-- Active Baits -->
                {% if active_baits %}
                <div class="rod-info mt-3">
                    <h5>‚ú® {% trans "Iscas Ativas" %}</h5>
                    {% for user_bait in active_baits %}
                    <div class="active-bait p-2 rounded mb-2">
                        <strong>{{ user_bait.bait.name }}</strong> - 
                        {% trans "Expira em" %}: {{ user_bait.expires_at|date:"d/m/Y H:i" }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">{{ stats.total_catches|default:0 }}</div>
                    <div>{% trans "Total de Pescarias" %}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value text-success">{{ stats.successful_catches|default:0 }}</div>
                    <div>{% trans "Peixes Capturados" %}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #3b82f6;">{{ stats.rare_fish|default:0 }}</div>
                    <div>{% trans "Peixes Raros" %}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #a855f7;">{{ stats.epic_fish|default:0 }}</div>
                    <div>{% trans "Peixes √âpicos" %}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #fbbf24;">{{ stats.legendary_fish|default:0 }}</div>
                    <div>{% trans "Peixes Lend√°rios" %}</div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Bait Shop -->
            <div class="bait-shop">
                <h4>üè™ {% trans "Loja de Iscas" %}</h4>
                {% if available_baits %}
                    {% for bait in available_baits %}
                    <div class="bait-item">
                        <div>
                            <strong>{{ bait.name }}</strong>
                            <div class="text-muted small">{{ bait.description }}</div>
                            <div class="text-muted small">
                                +{{ bait.boost_percentage }}% para {{ bait.get_rarity_boost_display }}
                            </div>
                            <div class="text-muted small">‚è±Ô∏è {{ bait.duration_minutes }} min</div>
                        </div>
                        <button class="buy-bait-btn" onclick="buyBait({{ bait.id }}, {{ bait.price }})">
                            {{ bait.price }} üí∞
                        </button>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">{% trans "Nenhuma isca dispon√≠vel." %}</p>
                {% endif %}
            </div>

            <!-- Available Fish -->
            <div class="bait-shop mt-3">
                <h4>üêü {% trans "Peixes Dispon√≠veis" %}</h4>
                <div class="fish-grid">
                    {% for fish in available_fish %}
                    <div class="fish-card rarity-{{ fish.rarity }}">
                        <div class="fish-icon">
                            {% if fish.image %}
                                <img src="{{ fish.image.url }}" alt="{{ fish.name }}" 
                                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                            {% else %}
                                {{ fish.icon }}
                            {% endif %}
                        </div>
                        <div><strong>{{ fish.name }}</strong></div>
                        <div class="text-muted small">{{ fish.get_rarity_display }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Fishing History -->
    <div class="bait-shop mt-3">
        <h4>üìã {% trans "Hist√≥rico de Pescarias" %}</h4>
        {% if fishing_history %}
            {% for history in fishing_history %}
            <div class="bait-item">
                <span>
                    {% if history.fish.image %}
                        <img src="{{ history.fish.image.url }}" alt="{{ history.fish.name }}" 
                             style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px; margin-right: 8px; vertical-align: middle;">
                    {% else %}
                        <span style="font-size: 1.5rem; margin-right: 8px;">{{ history.fish.icon }}</span>
                    {% endif %}
                    <strong>{{ history.fish.name }}</strong>
                    <span class="badge bg-secondary">{{ history.fish.get_rarity_display }}</span>
                    <small class="text-muted">- {{ history.created_at|date:"d/m/Y H:i" }}</small>
                </span>
                <span class="{% if history.success %}text-success{% else %}text-danger{% endif %}">
                    {% if history.success %}‚úÖ {% trans "Sucesso" %}{% else %}‚ùå {% trans "Escapou" %}{% endif %}
                </span>
            </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">{% trans "Voc√™ ainda n√£o pescou nada." %}</p>
        {% endif %}
    </div>
</div>

<script>
let isFishing = false;

function castLine() {
    if (isFishing) return;
    
    isFishing = true;
    const button = document.getElementById('cast-button');
    const pondContent = document.getElementById('pond-content');
    const messageEl = document.getElementById('result-message');
    
    button.disabled = true;
    button.classList.add('casting');
    messageEl.textContent = 'üé£ {% trans "Pescando..." %}';
    pondContent.innerHTML = '<div style="font-size: 4rem; color: white;">üåäüåäüåä</div>';
    
    // Make AJAX request
    fetch('{% url "games:fishing_game_cast" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            pondContent.innerHTML = '<div style="font-size: 4rem; text-align: center; color: white;">üé£<br><small style="font-size: 1.5rem;">{% trans "Clique para pescar!" %}</small></div>';
            button.classList.remove('casting');
            button.disabled = false;
            isFishing = false;
            return;
        }
        
        setTimeout(() => {
            // Show caught fish
            if (data.success) {
                let fishDisplay = '';
                if (data.fish.image_url) {
                    fishDisplay = `<img src="${data.fish.image_url}" alt="${data.fish.name}" 
                                        style="width: 150px; height: 150px; object-fit: cover; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">`;
                } else {
                    fishDisplay = `<span style="font-size: 6rem;">${data.fish.icon}</span>`;
                }
                
                pondContent.innerHTML = `<div class="fish-caught">${fishDisplay}</div>`;
                messageEl.innerHTML = `<span style="color: #4ade80;">üéâ ${data.message}<br>+${data.xp_gained} XP</span>`;
                
                if (data.fichas_won > 0) {
                    messageEl.innerHTML += `<br>üí∞ +${data.fichas_won} fichas`;
                }
                
                if (data.item_won) {
                    messageEl.innerHTML += `<br>üì¶ ${data.item_won.name} +${data.item_won.enchant}`;
                }
            } else {
                pondContent.innerHTML = '<div style="font-size: 4rem; color: white;">üí®</div>';
                messageEl.innerHTML = `<span style="color: #f87171;">üò¢ ${data.message}<br>+${data.xp_gained} XP</span>`;
            }
            
            // Update fichas and XP
            document.getElementById('user-fichas').textContent = data.user_fichas;
            
            button.classList.remove('casting');
            button.disabled = false;
            isFishing = false;
            
            // Reset pond after 3 seconds
            setTimeout(() => {
                pondContent.innerHTML = '<div style="font-size: 4rem; text-align: center; color: white;">üé£<br><small style="font-size: 1.5rem;">{% trans "Clique para pescar!" %}</small></div>';
                messageEl.textContent = '';
            }, 3000);
            
            // Reload after 4 seconds to update stats
            setTimeout(() => location.reload(), 4000);
        }, 2000);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{% trans "Erro ao pescar. Tente novamente." %}');
        pondContent.innerHTML = '<div style="font-size: 4rem; text-align: center; color: white;">üé£<br><small style="font-size: 1.5rem;">{% trans "Clique para pescar!" %}</small></div>';
        button.classList.remove('casting');
        button.disabled = false;
        isFishing = false;
    });
}

function buyBait(baitId, price) {
    if (!confirm(`{% trans "Comprar isca por" %} ${price} {% trans "fichas" %}?`)) {
        return;
    }
    
    const formData = new FormData();
    formData.append('bait_id', baitId);
    
    fetch('{% url "games:fishing_buy_bait" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }
        
        alert(data.message);
        location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{% trans "Erro ao comprar isca." %}');
    });
}
</script>
{% endblock %}

