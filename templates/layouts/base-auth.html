{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">

<head> 
  {% include 'includes/head.html' %}
  
  <!-- Shared Authentication Styles -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;800;900&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            'cinzel': ['Cinzel', 'serif'],
            'montserrat': ['Montserrat', 'sans-serif'],
          },
          colors: {
            primary: '#963e3a',
            'primary-dark': '#7d3232',
          }
        }
      }
    }
  </script>
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #eee9e0;
      background-image: url("{{ background_url }}");
      background-repeat: no-repeat;
      background-position: center center;
      background-attachment: fixed;
      background-size: cover;
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: 'Cinzel', serif;
    }

    .auth-panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.98) 0%, rgba(245,240,230,0.98) 100%);
      border: 1px solid #c5b8a5;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1), inset 0 0 0 1px rgba(255,255,255,0.5);
    }

    .btn-medieval {
      position: relative;
      background: linear-gradient(180deg, #8b3a3a 0%, #6b2a2a 50%, #5b1a1a 100%);
      border: 2px solid #4a1515;
      color: #f0e6d2;
      font-family: 'Cinzel', serif;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      padding: 12px 32px;
      clip-path: polygon(8px 0, calc(100% - 8px) 0, 100% 8px, 100% calc(100% - 8px), calc(100% - 8px) 100%, 8px 100%, 0 calc(100% - 8px), 0 8px);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.2), inset 0 -1px 0 rgba(0,0,0,0.3), 0 2px 4px rgba(0,0,0,0.3);
      transition: all 0.2s ease;
    }

    .btn-medieval:hover {
      background: linear-gradient(180deg, #9b4a4a 0%, #7b3a3a 50%, #6b2a2a 100%);
      transform: translateY(-1px);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.3), inset 0 -1px 0 rgba(0,0,0,0.3), 0 4px 8px rgba(0,0,0,0.4);
    }

    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #6b7280;
      transition: color 0.2s;
    }

    .password-toggle:hover {
      color: #374151;
    }
  </style>
  
  {% block extrastyle %}{% endblock extrastyle %}
</head>

  <main>

    {% block content %}{% endblock content %}

  </main>

  {% include 'includes/scripts.html' %}
  {% block extra_js %}{% endblock extra_js %}
  <script>
    (function () {
      const LOCK_URL = "{% url 'activate_lock' %}";
      const LOCK_URL_ALT = "{% url 'lock' %}";
      const INACTIVITY_MINUTES = 5;
      const TIME_LIMIT = INACTIVITY_MINUTES * 60 * 1000; // 5 minutos em milissegundos

      // Lista de caminhos permitidos (mesmos do middleware)
      const ALLOWED_PATHS = [
        "{{ settings.STATIC_URL }}",
        "{{ settings.MEDIA_URL }}",
        '/decrypted-file/',
        '/public/',
        '/wiki/',
        '/pages/',
        '/set-language/',
        '/verify/',
        '/components/',
        '/accounts/',
      ];

      let inactivityTimer;

      function isPathAllowed(path) {
        return ALLOWED_PATHS.some(allowedPath => path.startsWith(allowedPath));
      }

      function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(() => {
          const currentPath = window.location.pathname;
          
          // Não redireciona se estiver em páginas de lock ou em caminhos permitidos
          if (currentPath === LOCK_URL || 
              currentPath === LOCK_URL_ALT || 
              isPathAllowed(currentPath)) {
            return;
          }

          // Usa o parâmetro next como Django faz
          const fullPath = currentPath + window.location.search;
          window.location.href = `${LOCK_URL}?next=${encodeURIComponent(fullPath)}`;
        }, TIME_LIMIT);
      }

      // Atividade reinicia o timer
      const activityEvents = ['mousemove', 'mousedown', 'keydown', 'touchstart', 'scroll'];
      activityEvents.forEach(event => {
        document.addEventListener(event, resetInactivityTimer, true);
      });

      // Inicia o timer
      resetInactivityTimer();
    })();
  </script>
<body>