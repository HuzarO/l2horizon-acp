{% load static i18n itens_extras %}

<!-- Modal -->
<div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="notificationModalLabel">{% trans "Detalhes da Notifica√ß√£o" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Fechar' %}"></button>
      </div>
      <div class="modal-body">
        <!-- Os detalhes da notifica√ß√£o ser√£o carregados aqui -->
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <div id="notification-link-container" class="d-none">
          <a id="notification-link" href="#" class="btn btn-primary" target="_blank">
            <i class="bi bi-box-arrow-up-right"></i> {% trans "Acessar" %}
          </a>
        </div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Fechar" %}</button>
      </div>
    </div>
  </div>
</div>

<style>
  #notificationDropdown {
    left: -220px;
  }

  /* Estilos para pr√™mios nas notifica√ß√µes (usando sistema do battle pass) */
  .notification-rewards-preview {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .reward-item-preview {
    position: relative;
  }

  .reward-item-icon-small {
    width: 32px;
    height: 32px;
    object-fit: contain;
    border: 2px solid rgba(255, 215, 0, 0.3);
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.05);
    padding: 2px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .reward-amount {
    position: absolute;
    bottom: -2px;
    right: -2px;
    background: rgba(0, 0, 0, 0.8);
    color: #ffd700;
    font-size: 0.7rem;
    font-weight: bold;
    padding: 1px 4px;
    border-radius: 3px;
  }

  .notification-rewards {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  .reward-items-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .reward-item-container {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 0.5rem;
    border: 1px solid rgba(255, 215, 0, 0.2);
  }

  .reward-item-icon {
    width: 48px;
    height: 48px;
    object-fit: contain;
    border: 2px solid rgba(255, 215, 0, 0.3);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.05);
    padding: 4px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
  }

  .reward-item-icon:hover {
    transform: scale(1.1);
    border-color: #ffd700;
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.5);
  }

  .reward-item-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    flex: 1;
  }

  .reward-item-name {
    font-weight: 600;
    color: #ffd700;
    font-size: 0.95rem;
  }

  .reward-item-details {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.7);
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .reward-item-detail {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .reward-item-detail i {
    font-size: 0.75rem;
  }

  .list-group-item {
    position: relative;
  }
</style>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<!-- Bot√µes com mensagens traduzidas -->
<div style="display: none;">
  <span id="clear-confirm-message">{% trans "Tem certeza de que deseja limpar todas as notifica√ß√µes?" %}</span>
  <span id="error-loading-details">{% trans "Erro ao carregar os detalhes da notifica√ß√£o." %}</span>
  <span id="created-at-label">{% trans "Criado em:" %}</span>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    function loadNotifications() {
      fetch("{% url 'notification:notification_list' %}")
        .then(response => response.json())
        .then(data => {
          const notificationList = document.getElementById('notification-list');
          const notificationBadge = document.getElementById('notification-count');
          let notificationCount = 0;
          notificationList.innerHTML = '';

          data.notifications.forEach(notification => {
            const listItem = document.createElement('a');
            listItem.href = "#";
            listItem.className = `list-group-item list-group-item-action border-bottom ${notification.viewed ? 'viewed' : ''}`;
            listItem.setAttribute('data-bs-toggle', 'modal');
            listItem.setAttribute('data-bs-target', '#notificationModal');
            listItem.setAttribute('data-notification-id', notification.id);

            // Monta HTML dos pr√™mios se houver
            let rewardsHtml = '';
            if (notification.has_rewards && notification.rewards && notification.rewards.length > 0) {
              rewardsHtml = '<div class="notification-rewards-preview mt-2">';
              notification.rewards.forEach(reward => {
                const itemImageUrl = `/static/assets/img/l2/icons/5-${reward.item_id}.jpg`;
                rewardsHtml += `
                  <div class="reward-item-preview d-inline-block me-2 mb-1" title="${reward.item_name}">
                    <img src="${itemImageUrl}" 
                         alt="${reward.item_name}" 
                         class="reward-item-icon-small"
                         onerror="this.src='{% static 'assets/img/l2/icons/default.jpg' %}'">
                    ${reward.item_amount > 1 ? `<span class="reward-amount">x${reward.item_amount}</span>` : ''}
                  </div>
                `;
              });
              rewardsHtml += '</div>';
            }

            listItem.innerHTML = `
              <div class="row align-items-center">
                <div class="col-auto">
                  ${notification.has_rewards && notification.rewards && notification.rewards.length > 0 
                    ? `<img alt="Reward" src="/static/assets/img/l2/icons/5-${notification.rewards[0].item_id}.jpg" 
                             class="avatar-md rounded" 
                             onerror="this.src='{% static 'assets/img/logo_painel.png' %}'">`
                    : `<img alt="Image placeholder" src="{% static 'assets/img/logo_painel.png' %}" class="avatar-md rounded">`
                  }
                  ${notification.has_rewards && !notification.rewards_claimed 
                    ? '<span class="badge bg-success position-absolute top-0 start-100 translate-middle rounded-pill" style="font-size: 0.6rem;">üéÅ</span>' 
                    : ''}
                </div>
                <div class="col ps-0 ms-2">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h4 class="h6 mb-0 text-small">${notification.type}</h4>
                    </div>
                    <div class="text-end">
                      <small class="text-danger">${notification.created_at}</small>
                    </div>
                  </div>
                  <p class="font-small mt-1 mb-0">
                    ${notification.message}
                  </p>
                  ${rewardsHtml}
                </div>
              </div>
            `;

            notificationList.appendChild(listItem);
            if (!notification.viewed) notificationCount++;
          });

          if (notificationCount > 0) {
            notificationBadge.textContent = notificationCount;
            notificationBadge.style.display = 'inline';
          } else {
            notificationBadge.style.display = 'none';
          }
        });
    }

    document.getElementById('mark-as-read').addEventListener('click', function () {
      fetch("{% url 'notification:mark_all_as_read' %}").then(loadNotifications);
    });

    document.getElementById('clear-all').addEventListener('click', function () {
      const confirmMessage = document.getElementById('clear-confirm-message').textContent;
      if (confirm(confirmMessage)) {
        fetch("{% url 'notification:clear_all_notifications' %}").then(loadNotifications);
      }
    });

    document.getElementById('notificationModal').addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const notificationId = button.getAttribute('data-notification-id');
      const modalBody = document.querySelector('#notificationModal .modal-body');
      const createdAtLabel = document.getElementById('created-at-label').textContent;
      const errorLoadingDetails = document.getElementById('error-loading-details').textContent;

      fetch(`/app/notification/detail/${notificationId}/`)
        .then(response => response.json())
        .then(data => {
          // Monta HTML dos pr√™mios
          let rewardsHtml = '';
          if (data.has_rewards && data.rewards && data.rewards.length > 0) {
            rewardsHtml = '<div class="notification-rewards mt-3">';
            rewardsHtml += '<h6 class="mb-3"><i class="fas fa-gift"></i> Pr√™mios:</h6>';
            rewardsHtml += '<div class="reward-items-container">';
            data.rewards.forEach(reward => {
              const itemImageUrl = `/static/assets/img/l2/icons/5-${reward.item_id}.jpg`;
              rewardsHtml += `
                <div class="reward-item-container">
                  <img src="${itemImageUrl}" 
                       alt="${reward.item_name}" 
                       class="reward-item-icon"
                       title="${reward.item_name}"
                       onerror="this.src='{% static 'assets/img/l2/icons/default.jpg' %}'">
                  <div class="reward-item-info">
                    <div class="reward-item-name">${reward.item_name}</div>
                    <div class="reward-item-details">
                      ${reward.item_enchant > 0 ? `<div class="reward-item-detail"><i class="fas fa-magic"></i> +${reward.item_enchant}</div>` : ''}
                      ${reward.item_amount > 1 ? `<div class="reward-item-detail"><i class="fas fa-layer-group"></i> x${reward.item_amount}</div>` : ''}
                    </div>
                  </div>
                </div>
              `;
            });
            rewardsHtml += '</div>';
            
            // Bot√£o para reclamar pr√™mios se ainda n√£o foram reclamados
            if (!data.rewards_claimed) {
              rewardsHtml += `
                <div class="mt-3">
                  <button id="claim-rewards-btn" class="btn btn-success" onclick="claimNotificationRewards(${notificationId})">
                    <i class="fas fa-gift"></i> Reclamar Pr√™mios
                  </button>
                </div>
              `;
            } else {
              rewardsHtml += `
                <div class="mt-3">
                  <span class="badge bg-success"><i class="fas fa-check"></i> Pr√™mios Reclamados</span>
                </div>
              `;
            }
            rewardsHtml += '</div>';
          }

          modalBody.innerHTML = `
            <div class="notification-details">
              <div class="notification-type"><i class="fas fa-info-circle"></i> ${data.type}</div>
              <div class="notification-message">${data.message}</div>
              <div class="notification-created-at">
                <i class="far fa-clock"></i> ${createdAtLabel} ${data.created_at}
              </div>
              ${rewardsHtml}
            </div>
          `;

          const linkContainer = document.getElementById('notification-link-container');
          const linkButton = document.getElementById('notification-link');

          if (data.link) {
            linkButton.href = data.link;
            linkContainer.classList.remove('d-none');
          } else {
            linkContainer.classList.add('d-none');
          }

          loadNotifications();
        })
        .catch(() => {
          modalBody.innerHTML = `<p class="text-danger">${errorLoadingDetails}</p>`;
        });
    });

    loadNotifications();
  });

  function claimNotificationRewards(notificationId) {
    const btn = document.getElementById('claim-rewards-btn');
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reclamando...';
    }

    fetch(`/app/notification/claim-rewards/${notificationId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json',
      },
    })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Mostra mensagem de sucesso
          if (btn) {
            btn.innerHTML = '<i class="fas fa-check"></i> Pr√™mios Reclamados!';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-secondary');
          }
          
          // Atualiza a lista de notifica√ß√µes
          loadNotifications();
          
          // Recarrega os detalhes da notifica√ß√£o no modal
          fetch(`/app/notification/detail/${notificationId}/`)
            .then(response => response.json())
            .then(data => {
              const modalBody = document.querySelector('#notificationModal .modal-body');
              const createdAtLabel = document.getElementById('created-at-label').textContent;
              
              // Monta HTML dos pr√™mios novamente
              let rewardsHtml = '';
              if (data.has_rewards && data.rewards && data.rewards.length > 0) {
                rewardsHtml = '<div class="notification-rewards mt-3">';
                rewardsHtml += '<h6 class="mb-3"><i class="fas fa-gift"></i> Pr√™mios:</h6>';
                rewardsHtml += '<div class="reward-items-container">';
                data.rewards.forEach(reward => {
                  const itemImageUrl = `/static/assets/img/l2/icons/5-${reward.item_id}.jpg`;
                  rewardsHtml += `
                    <div class="reward-item-container">
                      <img src="${itemImageUrl}" 
                           alt="${reward.item_name}" 
                           class="reward-item-icon"
                           title="${reward.item_name}"
                           onerror="this.src='{% static 'assets/img/l2/icons/default.jpg' %}'">
                      <div class="reward-item-info">
                        <div class="reward-item-name">${reward.item_name}</div>
                        <div class="reward-item-details">
                          ${reward.item_enchant > 0 ? `<div class="reward-item-detail"><i class="fas fa-magic"></i> +${reward.item_enchant}</div>` : ''}
                          ${reward.item_amount > 1 ? `<div class="reward-item-detail"><i class="fas fa-layer-group"></i> x${reward.item_amount}</div>` : ''}
                        </div>
                      </div>
                    </div>
                  `;
                });
                rewardsHtml += '</div>';
                
                if (data.rewards_claimed) {
                  rewardsHtml += '<div class="mt-3"><span class="badge bg-success"><i class="fas fa-check"></i> Pr√™mios Reclamados</span></div>';
                }
                rewardsHtml += '</div>';
              }
              
              modalBody.innerHTML = `
                <div class="notification-details">
                  <div class="notification-type"><i class="fas fa-info-circle"></i> ${data.type}</div>
                  <div class="notification-message">${data.message}</div>
                  <div class="notification-created-at">
                    <i class="far fa-clock"></i> ${createdAtLabel} ${data.created_at}
                  </div>
                  ${rewardsHtml}
                </div>
              `;
            });
        } else {
          alert(data.error || 'Erro ao reclamar pr√™mios.');
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-gift"></i> Reclamar Pr√™mios';
          }
        }
      })
      .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao reclamar pr√™mios.');
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-gift"></i> Reclamar Pr√™mios';
        }
      });
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
